<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Anlios Dashboard{% endblock %}</title>
    <!-- Bootstrap 5.3.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Hojas de Estilo Base -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/toast.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
    <!-- Hojas de Estilo de Diseño (se activan/desactivan con JS) -->
    <link rel="stylesheet" id="design-anlios" href="{{ url_for('static', filename='css/designs/design-anlios.css') }}" disabled>
    <link rel="stylesheet" id="design-discord" href="{{ url_for('static', filename='css/designs/design-discord.css') }}" disabled>
    <link rel="stylesheet" id="design-nordic" href="{{ url_for('static', filename='css/designs/design-nordic.css') }}" disabled>
    <!-- Hojas de Estilo de Color (se activan/desactivan con JS) -->
    <link rel="stylesheet" id="color-furia-roja" href="{{ url_for('static', filename='css/colors/color-furia-roja.css') }}" disabled>
    <link rel="stylesheet" id="color-oceano-neon" href="{{ url_for('static', filename='css/colors/color-oceano-neon.css') }}" disabled>
    <link rel="stylesheet" id="color-atardecer" href="{{ url_for('static', filename='css/colors/color-atardecer.css') }}" disabled>
    <link rel="stylesheet" id="color-bosque-encantado" href="{{ url_for('static', filename='css/colors/color-bosque-encantado.css') }}" disabled>
    <link rel="stylesheet" id="color-menta-glacial" href="{{ url_for('static', filename='css/colors/color-menta-glacial.css') }}" disabled>
    <link rel="stylesheet" id="color-cerezo-en-flor" href="{{ url_for('static', filename='css/colors/color-cerezo-en-flor.css') }}" disabled>
    <link rel="stylesheet" id="color-grafito-y-oro" href="{{ url_for('static', filename='css/colors/color-grafito-y-oro.css') }}" disabled>
    <link rel="stylesheet" id="color-tierra-y-cielo" href="{{ url_for('static', filename='css/colors/color-tierra-y-cielo.css') }}" disabled>
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <!-- Scripts movidos al head para asegurar su disponibilidad -->
    <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
    {% block head_extra %}{% endblock %}
</head>
<body data-design="anlios">
    <div id="toast-container"></div>
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-flex flex-column p-3">
            <a href="{{ url_for('dashboard_home') }}" class="sidebar-brand d-flex align-items-center mb-4 text-decoration-none">
                <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Anlios Logo" width="40" height="40">
                <span class="fs-4 ms-2">Anlios</span>
            </a>
            <ul class="nav nav-pills flex-column mb-auto">
                {% if guild %}
                <li class="nav-item">
                    <a href="{{ url_for('manage_server', guild_id=guild.id) }}" class="nav-link {% if request.endpoint == 'manage_server' %}active{% endif %}">
                        <i class="bi bi-house-door-fill me-2"></i> {{ _('Home') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('module_ticket_ia', guild_id=guild.id) }}" class="nav-link {% if request.endpoint == 'module_ticket_ia' %}active{% endif %}">
                        <i class="bi bi-robot me-2"></i> {{ _('Ticket IA Module') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('module_moderation', guild_id=guild.id) }}" class="nav-link {% if request.endpoint == 'module_moderation' %}active{% endif %}">
                        <i class="bi bi-shield-fill-check me-2"></i> {{ _('Moderation Module') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{{ url_for('under_construction') }}" class="nav-link {% if request.endpoint == 'under_construction' %}active{% endif %}">
                        <i class="bi bi-tools me-2"></i> {{ _('More Modules...') }}
                    </a>
                </li>
                {% endif %}
            </ul>
            <hr>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle" id="dropdownUser" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="{{ user.avatar_url }}" alt="" width="32" height="32" class="rounded-circle me-2">
                    <strong>{{ user.name }}</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser">
                    <li><a class="dropdown-item" href="{{ url_for('profile_page') }}"><i class="bi bi-palette-fill me-2"></i>{{ _('Profile') }}</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('dashboard_home') }}"><i class="bi bi-server me-2"></i>{{ _('Change Server') }}</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>{{ _('Logout') }}</a></li>
                </ul>
            </div>
        </div>
        <!-- Contenido Principal -->
        <main class="main-content p-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                showToast("{{ message }}", "{{ category }}");
                            });
                        </script>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            {% block dashboard_content %}{% endblock %}
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}

    <!-- ================================================================== -->
    <!--  NUEVO SCRIPT DE GESTIÓN DE TEMAS CON GUARDADO AUTOMÁTICO          -->
    <!-- ================================================================== -->
    {% block theme_scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const designSheets = document.querySelectorAll('link[id^="design-"]');
            const colorSheets = document.querySelectorAll('link[id^="color-"]');
            const body = document.body;
            
            const designContainer = document.getElementById('design-selector-container');
            const colorContainer = document.getElementById('color-selector-container');

            let currentTheme = { design: 'anlios', color: 'furia-roja' };

            // Aplica el tema visualmente cambiando las hojas de estilo
            function applyTheme(design, color) {
                body.classList.add('theme-transition');
                body.dataset.design = design;

                designSheets.forEach(sheet => sheet.disabled = (sheet.id !== `design-${design}`));
                colorSheets.forEach(sheet => sheet.disabled = (sheet.id !== `color-${color}`));

                // Actualiza las variables de CSS dependientes (ej. para el toast)
                setTimeout(() => {
                    const computedStyle = getComputedStyle(body);
                    const toastContainer = document.getElementById('toast-container');
                    if (toastContainer) {
                        toastContainer.style.setProperty('--toast-font-family', computedStyle.getPropertyValue('--font-pixel').trim());
                        toastContainer.style.setProperty('--toast-bg', computedStyle.getPropertyValue('--bg-tertiary').trim());
                        toastContainer.style.setProperty('--toast-border', computedStyle.getPropertyValue('--accent-main').trim());
                        toastContainer.style.setProperty('--toast-progress-bg', computedStyle.getPropertyValue('--bg-secondary').trim());
                        toastContainer.style.setProperty('--toast-progress-fill', computedStyle.getPropertyValue('--accent-main').trim());
                    }
                    body.classList.remove('theme-transition');
                }, 50);
            }

            // Guarda el tema en el almacenamiento local del navegador
            function saveTheme(design, color) {
                localStorage.setItem('userTheme', JSON.stringify({ design, color }));
            }
            
            // Carga el tema guardado al iniciar la página
            function loadTheme() {
                const savedTheme = JSON.parse(localStorage.getItem('userTheme')) || { design: 'anlios', color: 'furia-roja' };
                currentTheme = savedTheme;
                applyTheme(savedTheme.design, savedTheme.color);
                updateActiveSelectors();
            }

            // Actualiza cuál tarjeta/círculo se muestra como "activo"
            function updateActiveSelectors() {
                if (designContainer) {
                    const designCards = designContainer.querySelectorAll('.theme-card');
                    designCards.forEach(card => {
                        card.classList.toggle('active', card.dataset.design === currentTheme.design);
                    });
                }
                if (colorContainer) {
                    const colorSwatches = colorContainer.querySelectorAll('.color-swatch');
                    colorSwatches.forEach(swatch => {
                        swatch.classList.toggle('active', swatch.dataset.color === currentTheme.color);
                    });
                }
            }
            
            // Evento para seleccionar un diseño
            if (designContainer) {
                designContainer.addEventListener('click', (e) => {
                    const selectedCard = e.target.closest('.theme-card');
                    if (!selectedCard) return;

                    currentTheme.design = selectedCard.dataset.design;
                    applyTheme(currentTheme.design, currentTheme.color);
                    saveTheme(currentTheme.design, currentTheme.color);
                    updateActiveSelectors();
                });
            }
            
            // Evento para seleccionar un color
            if (colorContainer) {
                colorContainer.addEventListener('click', (e) => {
                    const selectedSwatch = e.target.closest('.color-swatch');
                    if (!selectedSwatch) return;

                    currentTheme.color = selectedSwatch.dataset.color;
                    applyTheme(currentTheme.design, currentTheme.color);
                    saveTheme(currentTheme.design, currentTheme.color);
                    updateActiveSelectors();
                });
            }

            // Cargar el tema al iniciar
            loadTheme();
        });
    </script>
    {% endblock %}
</body>
</html>