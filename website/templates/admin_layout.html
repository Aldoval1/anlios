<!-- admin_templates/admin_layout.html -->
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Admin Anlios{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { position: fixed; top: 0; bottom: 0; left: 0; z-index: 100; padding: 48px 0 0; box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1); }
        .sidebar-sticky { position: relative; top: 0; height: calc(100vh - 48px); padding-top: .5rem; overflow-x: hidden; overflow-y: auto; }
        .nav-link { font-weight: 500; }
        main { padding-top: 2rem; }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Admin Anlios</a>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="{{ url_for('admin_logout') }}">Cerrar Sesión</a>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="sidebar-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'manage_codes' %}active{% endif %}" href="{{ url_for('manage_codes') }}">Códigos Premium</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'manage_subscriptions' %}active{% endif %}" href="{{ url_for('manage_subscriptions') }}">Suscripciones</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'audit_log' %}active{% endif %}" href="{{ url_for('audit_log') }}">Registro de Auditoría</a></li>
                        <li class="nav-item"><a class="nav-link {% if request.endpoint == 'server_viewer' %}active{% endif %}" href="{{ url_for('server_viewer') }}">Visor de Servidores</a></li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
</body>
</html>

<!-- admin_templates/admin_login.html -->
<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Inicio de Sesión Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body { height: 100%; }
        body { display: flex; align-items: center; padding-top: 40px; padding-bottom: 40px; background-color: #f5f5f5; }
        .form-signin { width: 100%; max-width: 330px; padding: 15px; margin: auto; }
    </style>
</head>
<body class="text-center">
    <main class="form-signin">
        <form method="POST">
            <h1 class="h3 mb-3 fw-normal">Inicio de Sesión Admin</h1>
            <div class="form-floating">
                <input type="password" class="form-control" id="password" name="password" placeholder="Contraseña">
                <label for="password">Contraseña</label>
            </div>
            <button class="w-100 btn btn-lg btn-primary mt-3" type="submit">Iniciar Sesión</button>
        </form>
    </main>
</body>
</html>

<!-- admin_templates/manage_premium.html -->
{% extends "admin_layout.html" %}
{% block title %}Gestionar Códigos{% endblock %}
{% block content %}
    <h2>Gestionar Códigos Premium</h2>
    <div class="row">
        <div class="col-md-6">
            <h4>Generar Nuevo Código</h4>
            <form method="POST">
                <input type="hidden" name="action" value="generate">
                <div class="mb-3">
                    <label for="duration" class="form-label">Duración (días)</label>
                    <input type="number" class="form-control" id="duration" name="duration" required>
                </div>
                <button type="submit" class="btn btn-primary">Generar</button>
            </form>
        </div>
        <div class="col-md-6">
            <h4>Códigos Existentes</h4>
            <table class="table">
                <thead><tr><th>Código</th><th>Duración (Días)</th><th>Estado</th><th>Acción</th></tr></thead>
                <tbody>
                {% for code, data in codes.items() %}
                    <tr>
                        <td>{{ code }}</td>
                        <td>{{ (data.duration / 86400) | int }}</td>
                        <td>{{ "Activo" if data.is_active else "Usado/Inactivo" }}</td>
                        <td>
                            {% if data.is_active %}
                            <form method="POST" class="d-inline">
                                <input type="hidden" name="action" value="deactivate">
                                <input type="hidden" name="code" value="{{ code }}">
                                <button type="submit" class="btn btn-warning btn-sm">Desactivar</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

<!-- admin_templates/subscriptions.html -->
{% extends "admin_layout.html" %}
{% block title %}Suscripciones{% endblock %}
{% block content %}
    <h2>Suscripciones Activas</h2>
    <table class="table">
        <thead><tr><th>ID del Servidor</th><th>Expira en</th></tr></thead>
        <tbody>
        {% for guild_id, data in subscriptions.items() %}
            <tr>
                <td>{{ guild_id }}</td>
                <td>{{ data.expires_at | from_timestamp }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}

<!-- admin_templates/audit_log.html -->
{% extends "admin_layout.html" %}
{% block title %}Registro de Auditoría{% endblock %}
{% block content %}
    <h2>Registro de Auditoría del Dashboard</h2>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead><tr><th>Fecha y Hora</th><th>Usuario</th><th>Acción</th><th>Detalles</th></tr></thead>
            <tbody>
            {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp | from_timestamp }}</td>
                    <td>{{ log.user.username }} ({{ log.user.id }})</td>
                    <td>{{ log.action }}</td>
                    <td><pre style="white-space: pre-wrap; word-break: break-all;">{{ log.details | tojson(indent=2) }}</pre></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

<!-- admin_templates/server_viewer.html -->
{% extends "admin_layout.html" %}
{% block title %}Visor de Servidores{% endblock %}
{% block content %}
    <h2>Visor de Configuración de Servidores</h2>
    <p>Selecciona un servidor para ver sus datos de configuración en vivo desde la base de datos.</p>
    <div class="list-group">
        {% for guild_id in guild_ids %}
            <a href="{{ url_for('view_server_config', guild_id=guild_id) }}" class="list-group-item list-group-item-action">
                ID del Servidor: {{ guild_id }}
            </a>
        {% else %}
            <p class="text-muted">No se encontraron servidores.</p>
        {% endfor %}
    </div>
{% endblock %}

<!-- admin_templates/view_server_config.html -->
{% extends "admin_layout.html" %}
{% block title %}Ver Config: {{ data.guild_id }}{% endblock %}
{% block content %}
    <a href="{{ url_for('server_viewer') }}">&larr; Volver a la Lista de Servidores</a>
    <h2 class="mt-3">Viendo Configuración para el Servidor: {{ data.guild_id }}</h2>
    <hr>
    
    <div class="card mb-4">
        <div class="card-header">Estado del Módulo</div>
        <div class="card-body">
            <p><strong>Módulo de Ticket IA Activado:</strong> {{ data.module_status }}</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Configuración de Tickets y Logs</div>
        <div class="card-body">
            <pre>{{ data.ticket_config | tojson(indent=2) }}</pre>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Configuración de Embeds y Prompt de IA</div>
        <div class="card-body">
            <pre>{{ data.embed_config | tojson(indent=2) }}</pre>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Base de Conocimientos</div>
        <div class="card-body">
            {% if data.knowledge_base %}
                <ul>
                {% for item in data.knowledge_base %}
                    <li><pre>{{ item }}</pre></li>
                {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">La base de conocimientos está vacía.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}