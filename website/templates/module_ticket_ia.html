{% extends "dashboard.html" %}
{% block title %}Módulo: Ticket I.A{% endblock %}

{% block dashboard_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Módulo: Ticket I.A</h1>
        <form method="POST">
            <input type="hidden" name="action" value="toggle_module">
            <input type="hidden" name="module_name" value="ticket_ia">
            <div class="form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" role="switch" id="module-toggle" name="enabled" {% if module_status %}checked{% endif %} onchange="this.form.submit()">
                <label class="form-check-label" for="module-toggle">Habilitado</label>
            </div>
        </form>
    </div>

    {% if module_status %}
    <div class="row g-5">
        <!-- Columna Izquierda: Formularios de Configuración -->
        <div class="col-md-7">
            <form method="POST" id="main-config-form">
                
                <!-- SECCIÓN 1: Editor de Embeds -->
                <section id="embeds-section" class="mb-5">
                    <h2>Editor de Embeds</h2>
                    <hr class="border-danger">
                    <div class="card mb-4 shadow-sm">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="embedTabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="panel-tab" data-bs-toggle="tab" data-bs-target="#panel-editor" type="button" role="tab">Panel de Tickets</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="welcome-tab" data-bs-toggle="tab" data-bs-target="#welcome-editor" type="button" role="tab">Embed de Bienvenida</button></li>
                            </ul>
                        </div>
                        <div class="card-body tab-content" id="embedTabsContent">
                            <!-- Editor del Panel de Tickets -->
                            <div class="tab-pane fade show active" id="panel-editor" role="tabpanel">
                                <div class="mb-3"><label class="form-label small">Texto del Botón</label><input type="text" class="form-control" id="panel_button_label" name="panel_button_label" value="{{ embed_config.panel.button_label }}" oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Título</label><input type="text" class="form-control" id="panel_title" name="panel_title" value="{{ embed_config.panel.title }}" oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Descripción</label><textarea class="form-control" id="panel_description" name="panel_description" rows="3" oninput="updatePreview()">{{ embed_config.panel.description }}</textarea></div>
                                <div class="mb-3"><label class="form-label small">Autor</label><input type="text" class="form-control" id="panel_author_name" name="panel_author_name" value="{{ embed_config.panel.author_name }}" placeholder="Texto del autor..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Icono del Autor (URL)</label><input type="url" class="form-control" id="panel_author_icon" name="panel_author_icon" value="{{ embed_config.panel.author_icon }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Imagen Principal (URL)</label><input type="url" class="form-control" id="panel_image" name="panel_image" value="{{ embed_config.panel.image }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Miniatura (URL)</label><input type="url" class="form-control" id="panel_thumbnail" name="panel_thumbnail" value="{{ embed_config.panel.thumbnail }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Pie de Página (Footer)</label><input type="text" class="form-control" id="panel_footer_text" name="panel_footer_text" value="{{ embed_config.panel.footer_text }}" placeholder="Texto del pie de página..." oninput="updatePreview()" maxlength="2048"></div>
                                <div class="mb-3"><label class="form-label small">Icono del Pie de Página (URL)</label><input type="url" class="form-control" id="panel_footer_icon" name="panel_footer_icon" value="{{ embed_config.panel.footer_icon }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Color</label><input type="color" class="form-control form-control-color" id="panel_color" name="panel_color" value="{{ embed_config.panel.color }}" oninput="updatePreview()"></div>
                            </div>
                            <!-- Editor del Embed de Bienvenida -->
                            <div class="tab-pane fade" id="welcome-editor" role="tabpanel">
                                <p class="text-muted small">Puedes usar `{user}` para mencionar al usuario.</p>
                                <div class="mb-3"><label class="form-label small">Título</label><input type="text" class="form-control" id="welcome_title" name="welcome_title" value="{{ embed_config.welcome.title }}" oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Descripción</label><textarea class="form-control" id="welcome_description" name="welcome_description" rows="3" oninput="updatePreview()">{{ embed_config.welcome.description }}</textarea></div>
                                <div class="mb-3"><label class="form-label small">Autor</label><input type="text" class="form-control" id="welcome_author_name" name="welcome_author_name" value="{{ embed_config.welcome.author_name }}" placeholder="Texto del autor..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Icono del Autor (URL)</label><input type="url" class="form-control" id="welcome_author_icon" name="welcome_author_icon" value="{{ embed_config.welcome.author_icon }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Imagen Principal (URL)</label><input type="url" class="form-control" id="welcome_image" name="welcome_image" value="{{ embed_config.welcome.image }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Miniatura (URL)</label><input type="url" class="form-control" id="welcome_thumbnail" name="welcome_thumbnail" value="{{ embed_config.welcome.thumbnail }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Pie de Página (Footer)</label><input type="text" class="form-control" id="welcome_footer_text" name="welcome_footer_text" value="{{ embed_config.welcome.footer_text }}" placeholder="Texto del pie de página..." oninput="updatePreview()" maxlength="2048"></div>
                                <div class="mb-3"><label class="form-label small">Icono del Pie de Página (URL)</label><input type="url" class="form-control" id="welcome_footer_icon" name="welcome_footer_icon" value="{{ embed_config.welcome.footer_icon }}" placeholder="https://..." oninput="updatePreview()"></div>
                                <div class="mb-3"><label class="form-label small">Color</label><input type="color" class="form-control form-control-color" id="welcome_color" name="welcome_color" value="{{ embed_config.welcome.color }}" oninput="updatePreview()"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 2: Personalidad de la IA -->
                <section id="ai-section" class="mb-5">
                    <h2>Personalidad de la IA</h2>
                    <hr class="border-danger">
                    <div class="card mt-4 shadow-sm">
                        <div class="card-body">
                            <p class="text-muted small">Define la personalidad y las reglas de la IA. Usa <code>{knowledge}</code> para indicarle dónde usar la información que le proporcionas. Si no conoce la respuesta, debe empezar su respuesta con <code>[NO_KNOWLEDGE]</code>.</p>
                            <textarea class="form-control" name="ai_prompt" rows="12">{{ embed_config.ai_prompt }}</textarea>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 3: Base de Conocimiento -->
                <section id="knowledge-section" class="mb-5">
                    <h2>Base de Conocimiento</h2>
                    <hr class="border-danger">
                    <div class="card mt-4 shadow-sm">
                        <div class="card-body">
                            <h6>Conocimiento Actual:</h6>
                            <ul class="list-group list-group-flush mb-3" style="max-height: 200px; overflow-y: auto;">
                                {% for item in knowledge_base %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span class="me-2 text-truncate" style="white-space: pre-wrap;">{{ item }}</span>
                                    <button type="submit" name="action" value="knowledge_delete_{{ loop.index0 }}" class="btn btn-danger btn-sm py-0 px-2" title="Eliminar">×</button>
                                </li>
                                {% endfor %}
                                {% if not knowledge_base %}
                                <li class="list-group-item text-muted">La base de conocimientos está vacía.</li>
                                {% endif %}
                            </ul>
                            <hr>
                            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="pills-text-tab" data-bs-toggle="pill" data-bs-target="#pills-text" type="button" role="tab">Añadir Texto</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="pills-web-tab" data-bs-toggle="pill" data-bs-target="#pills-web" type="button" role="tab">Leer Web</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="pills-youtube-tab" data-bs-toggle="pill" data-bs-target="#pills-youtube" type="button" role="tab">YouTube</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="pills-pdf-tab" data-bs-toggle="pill" data-bs-target="#pills-pdf" type="button" role="tab">Subir PDF</button></li>
                            </ul>
                            <div class="tab-content" id="pills-tabContent">
                                <div class="tab-pane fade show active" id="pills-text" role="tabpanel"><div class="mb-3"><textarea class="form-control" name="new_knowledge" rows="4" placeholder="Ej: Las normas del servidor están en el canal #reglas."></textarea></div><button type="submit" name="action" value="knowledge_add" class="btn btn-info w-100">Añadir Texto</button></div>
                                <div class="tab-pane fade" id="pills-web" role="tabpanel"><div class="input-group"><input type="url" class="form-control" name="web_url" placeholder="https://ejemplo.com"><button type="submit" name="action" value="knowledge_web" class="btn btn-info">Leer Página Web</button></div></div>
                                <div class="tab-pane fade" id="pills-youtube" role="tabpanel"><div class="input-group"><input type="url" class="form-control" name="youtube_url" placeholder="https://www.youtube.com/watch?v=..."><button type="submit" name="action" value="knowledge_youtube" class="btn btn-info">Transcribir Video</button></div></div>
                                <div class="tab-pane fade" id="pills-pdf" role="tabpanel"><div class="input-group"><input type="file" class="form-control" name="pdf_file" accept=".pdf"><button type="submit" name="action" value="knowledge_pdf" class="btn btn-info">Subir PDF</button></div></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- SECCIÓN 4: Configuración de Roles -->
                <section id="configs-section" class="mb-5">
                    <h2>Configuración de Roles</h2>
                    <hr class="border-danger">
                    <div class="card mt-4 shadow-sm">
                        <div class="card-body">
                            <p class="text-muted small">Haz doble clic en un rol para añadirlo a la lista de administradores de tickets.</p>
                            <div id="role-list-container">
                                {% for role in roles %}
                                    <div class="role-item" data-role-id="{{ role.id }}" data-role-name="{{ role.name }}">{{ role.name }}</div>
                                {% endfor %}
                            </div>
                            <hr>
                            <div class="d-flex align-items-start mt-2">
                                <span class="text-muted small me-3 pt-2" style="white-space: nowrap;">Roles con permiso:</span>
                                <div id="selected-roles-container" class="w-100" style="min-height: 40px;">
                                    <!-- Pills se renderizan con JS -->
                                </div>
                            </div>
                            <input type="hidden" name="admin_roles_json" id="admin-roles-json">
                        </div>
                    </div>
                </section>

                <button type="submit" name="action" value="save_all" class="btn btn-success w-100 btn-lg">Guardar Toda la Configuración</button>
            </form>
        </div>
        <!-- Columna Derecha: Vista Previa y Acciones -->
        <div class="col-md-5">
            <div class="sticky-top" style="top: 2rem;">
                <div class="card shadow-sm mb-4">
                    <div class="card-header"><h5 class="mb-0">Publicar Panel de Tickets</h5></div>
                    <div class="card-body">
                        <p class="small text-muted">Elige un canal para enviar el panel.</p>
                        <form action="{{ url_for('send_panel', guild_id=active_guild_id) }}" method="POST">
                            <div class="input-group"><select class="form-select" name="channel_id" required><option value="" disabled selected>Selecciona un canal...</option>{% for channel in channels %}<option value="{{ channel.id }}">#{{ channel.name }}</option>{% endfor %}</select><button class="btn btn-primary" type="submit">Enviar</button></div>
                        </form>
                    </div>
                </div>
                <div class="card shadow-sm">
                    <div class="card-header"><h5 class="mb-0">Vista Previa</h5></div>
                    <div class="card-body" style="background-color: #36393f; padding: 20px;">
                        <div class="discord-chat-message">
                            <img src="{{ url_for('static', filename='images/favicon.png') }}" class="discord-avatar">
                            <div>
                                <span class="discord-username">Anlios Bot</span>
                                <div id="panel-preview" class="discord-embed">
                                    <div class="embed-grid"><div class="embed-content"><div class="embed-author"><img class="embed-author-icon" src=""><span class="embed-author-name"></span></div><div class="embed-title"></div><div class="embed-description"></div></div><div class="embed-thumbnail-container"><img class="embed-thumbnail" src=""></div></div>
                                    <div class="embed-image-container"><img class="embed-image" src=""></div>
                                    <div class="embed-footer"><img class="embed-footer-icon" src=""><span class="embed-footer-text"></span></div>
                                </div>
                                <div id="welcome-preview" class="discord-embed" style="display:none;">
                                     <div class="embed-grid"><div class="embed-content"><div class="embed-author"><img class="embed-author-icon" src=""><span class="embed-author-name"></span></div><div class="embed-title"></div><div class="embed-description"></div></div><div class="embed-thumbnail-container"><img class="embed-thumbnail" src=""></div></div>
                                     <div class="embed-image-container"><img class="embed-image" src=""></div>
                                     <div class="embed-footer"><img class="embed-footer-icon" src=""><span class="embed-footer-text"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/preview.js') }}"></script>
<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
<script src="{{ url_for('static', filename='js/unsaved-changes.js') }}"></script>
<script id="initial-roles-data" type="application/json">{{ ticket_config.admin_roles | tojson | safe }}</script>
<script id="all-roles-data" type="application/json">{{ roles | tojson | safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const roleListContainer = document.getElementById('role-list-container');
    const selectedRolesContainer = document.getElementById('selected-roles-container');
    const hiddenRolesInput = document.getElementById('admin-roles-json');
    
    const initiallySelectedRoles = JSON.parse(document.getElementById('initial-roles-data').textContent || '[]');
    const allRoles = JSON.parse(document.getElementById('all-roles-data').textContent || '[]');
    
    let selectedRoleIds = new Set(initiallySelectedRoles.map(String));

    function updateHiddenInput() {
        hiddenRolesInput.value = JSON.stringify(Array.from(selectedRoleIds));
    }

    function renderPills() {
        selectedRolesContainer.innerHTML = '';
        const availableRoleItems = roleListContainer.querySelectorAll('.role-item');

        availableRoleItems.forEach(item => {
            item.style.display = 'block';
        });

        selectedRoleIds.forEach(roleId => {
            const role = allRoles.find(r => String(r.id) === roleId);
            if (role) {
                const pill = document.createElement('div');
                pill.className = 'selected-role-pill';
                pill.dataset.roleId = role.id;
                pill.innerHTML = `<span>${role.name}</span><button type="button" class="remove-role-btn">×</button>`;
                selectedRolesContainer.appendChild(pill);

                const availableRoleItem = roleListContainer.querySelector(`.role-item[data-role-id='${roleId}']`);
                if (availableRoleItem) {
                    availableRoleItem.style.display = 'none';
                }
            }
        });
    }

    function addRole(roleId) {
        selectedRoleIds.add(roleId);
        updateAndRender();
    }

    function removeRole(roleId) {
        selectedRoleIds.delete(roleId);
        updateAndRender();
    }

    function updateAndRender() {
        renderPills();
        updateHiddenInput();
    }

    if (roleListContainer) {
        roleListContainer.addEventListener('dblclick', e => {
            if (e.target && e.target.classList.contains('role-item')) {
                addRole(e.target.dataset.roleId);
            }
        });
    }

    if (selectedRolesContainer) {
        selectedRolesContainer.addEventListener('click', e => {
            if (e.target && e.target.classList.contains('remove-role-btn')) {
                removeRole(e.target.parentElement.dataset.roleId);
            }
        });
    }

    updateAndRender();
});
</script>
{% endblock %}