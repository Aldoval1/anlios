{% extends "layout.html" %}

{% block title %}{{ title }} - {{ server.name }}{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Incluir scripts para el editor de embeds -->
    <script src="{{ url_for('static', filename='js/preview.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="main-content-header">
    <a href="{{ url_for('manage_server', server_id=server.id) }}" class="back-button">&larr; {{ _('volver_a_modulos') }}</a>
    <h1>
        <img src="https://cdn.discordapp.com/icons/{{ server.id }}/{{ server.icon }}.png?size=64" alt="{{ _('icono_servidor') }}" class="server-icon-title">
        {{ server.name }}
    </h1>
</div>

<div class="module-container">
    <div class="module-header">
        <i class="fas fa-ticket-alt icon-ia-ticket"></i>
        <div class="module-header-info">
            <h2>{{ _('ia_ticket_titulo') }}</h2>
            <p>{{ _('ia_ticket_descripcion') }}</p>
        </div>
        <button class="button-primary save-button" id="save-general-config" data-form-id="general-config-form">
            <i class="fas fa-save"></i> {{ _('guardar_cambios') }}
        </button>
    </div>

    <!-- Configuración General y Panel -->
    <div class="form-section-horizontal">
        
        <!-- Columna Izquierda: Configuración -->
        <div class="form-column">
            <form id="general-config-form" class="card">
                <h3>{{ _('ia_ticket_config_panel') }}</h3>
                
                <!-- Personalidad IA -->
                <label for="ai-personality">{{ _('ia_ticket_personalidad_ia') }}</label>
                <textarea id="ai-personality" name="ai_personality" rows="4" class="input-field" placeholder="{{ _('ia_ticket_personalidad_placeholder') }}">{{ config.ai_personality or '' }}</textarea>
                
                <!-- Mensaje Bienvenida Ticket -->
                <label for="ticket-welcome-message">{{ _('ia_ticket_bienvenida_ticket') }}</label>
                <textarea id="ticket-welcome-message" name="ticket_welcome_message" rows="3" class="input-field" placeholder="{{ _('ia_ticket_bienvenida_placeholder') }}">{{ config.ticket_welcome_message or '' }}</textarea>

                <!-- Idioma IA -->
                <label for="ai-language">{{ _('ia_ticket_idioma_ia') }}</label>
                <select id="ai-language" name="ai_language" class="input-field">
                    <option value="es" {% if config.ai_language == 'es' %}selected{% endif %}>{{ _('ia_ticket_idioma_es') }}</option>
                    <option value="en" {% if config.ai_language == 'en' %}selected{% endif %}>{{ _('ia_ticket_idioma_en') }}</option>
                </select>

                <hr>

                <!-- Enviar Panel -->
                <h4>{{ _('ia_ticket_enviar_panel_titulo') }}</h4>
                <p class="description">{{ _('ia_ticket_enviar_panel_descripcion') }}</p>
                <div class="input-group">
                    <select id="send-panel-channel" class="input-field">
                        <option value="">{{ _('ia_ticket_seleccionar_canal') }}</option>
                        <!-- (JS cargará los canales aquí) -->
                    </select>
                    <button class="button-secondary" type="button" id="send-panel-btn">{{ _('ia_ticket_enviar_boton') }}</button>
                </div>
            </form>
        </div>
        
        <!-- Columna Derecha: Editor de Embed -->
        <div class="form-column">
            <div class="card embed-editor-card">
                <h3>{{ _('ia_ticket_vista_previa') }}</h3>
                <div class="embed-editor-container">
                    <!-- Inputs para editar el Embed -->
                    <div class="embed-editor-fields">
                        <label>Title</label>
                        <input type="text" id="embed-title" class="input-field" data-preview="embed-preview-title" value="{{ config.embed_config.title or '' }}">
                        
                        <label>Description</label>
                        <textarea id="embed-description" class="input-field" rows="5" data-preview="embed-preview-description">{{ config.embed_config.description or '' }}</textarea>
                        
                        <label>Color (Hex)</label>
                        <input type="color" id="embed-color-picker" value="{{ config.embed_config.color or '#5865F2' }}">
                        <input type="text" id="embed-color" class="input-field" data-preview="embed-preview-color" value="{{ config.embed_config.color or '#5865F2' }}">
                        
                        <label>Button Text</label>
                        <input type="text" id="embed-button-text" class="input-field" data-preview="embed-preview-button" value="{{ config.embed_config.button_text or 'Abrir Ticket' }}">
                    </div>
                    
                    <!-- Vista Previa del Embed (estilo Discord) -->
                    <div class="discord-embed-preview">
                        <div class="embed-preview-color-bar" id="embed-preview-color" style="background-color: {{ config.embed_config.color or '#5865F2' }};"></div>
                        <div class="embed-preview-content">
                            <div class="embed-preview-title" id="embed-preview-title">{{ config.embed_config.title or 'Título del Panel' }}</div>
                            <div class="embed-preview-description" id="embed-preview-description">{{ config.embed_config.description or 'Haz clic en el botón de abajo para abrir un ticket y recibir soporte.' }}</div>
                        </div>
                    </div>
                </div>
                <!-- Botón de Discord simulado -->
                <button class="discord-button-preview" type="button" disabled>
                    <i class="fas fa-ticket-alt"></i>
                    <span id="embed-preview-button">{{ config.embed_config.button_text or 'Abrir Ticket' }}</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sección Knowledge Base -->
    <div class="card form-section" id="knowledge-base-form">
        <h3>{{ _('ia_ticket_kb_titulo') }}</h3>
        <p class="description">{{ _('ia_ticket_kb_descripcion') }}</p>
        
        <div class="kb-input-tabs">
            <button class="kb-tab-button active" data-tab="text">{{ _('ia_ticket_kb_tipo_texto') }}</button>
            <button class="kb-tab-button" data-tab="url">{{ _('ia_ticket_kb_tipo_url') }}</button>
            <button class="kb-tab-button" data-tab="youtube">{{ _('ia_ticket_kb_tipo_youtube') }}</button>
            <button class="kb-tab-button" data-tab="file">{{ _('ia_ticket_kb_tipo_archivo') }}</button>
        </div>
        
        <div class="kb-input-content">
            <!-- Tab: Texto -->
            <div id="kb-tab-text" class="kb-tab-pane active">
                <div class="input-group">
                    <textarea id="kb-input-text" rows="3" class="input-field" placeholder="{{ _('ia_ticket_kb_texto_placeholder') }}"></textarea>
                    <button class="button-secondary" type="button" data-type="text" id="add-kb-text">{{ _('ia_ticket_kb_agregar_boton') }}</button>
                </div>
            </div>
            <!-- Tab: URL -->
            <div id="kb-tab-url" class="kb-tab-pane">
                <div class="input-group">
                    <input type="text" id="kb-input-url" class="input-field" placeholder="{{ _('ia_ticket_kb_url_placeholder') }}">
                    <button class="button-secondary" type="button" data-type="url" id="add-kb-url">{{ _('ia_ticket_kb_agregar_boton') }}</button>
                </div>
            </div>
            <!-- Tab: YouTube -->
            <div id="kb-tab-youtube" class="kb-tab-pane">
                <div class="input-group">
                    <input type="text" id="kb-input-youtube" class="input-field" placeholder="{{ _('ia_ticket_kb_youtube_placeholder') }}">
                    <button class="button-secondary" type="button" data-type="youtube" id="add-kb-youtube">{{ _('ia_ticket_kb_agregar_boton') }}</button>
                </div>
            </div>
            <!-- Tab: File -->
            <div id="kb-tab-file" class="kb-tab-pane">
                <div class="input-group">
                    <input type="file" id="file-upload" class="input-field" accept=".pdf,.txt,.md">
                    <label for="file-upload" class="button-secondary file-upload-label">{{ _('ia_ticket_kb_subir_archivo') }}</label>
                </div>
            </div>
        </div>

        <!-- Lista de Knowledge Base -->
        <h4>{{ _('ia_ticket_kb_archivos_actuales') }}</h4>
        <ul class="knowledge-base-list" id="file-list">
            {% if knowledge.texts %}
                {% for item in knowledge.texts %}
                <li>
                    <span><i class="fas fa-file-alt"></i> [Texto] {{ item | truncate(80) }}</span>
                    <button type="button" class="delete-file-btn" onclick="deleteKnowledge('{{ item | e }}', 'text')">&times;</button>
                </li>
                {% endfor %}
            {% endif %}
            {% if knowledge.urls %}
                {% for item in knowledge.urls %}
                <li>
                    <span><i class="fas fa-link"></i> [URL] {{ item }}</span>
                    <button type="button" class="delete-file-btn" onclick="deleteKnowledge('{{ item | e }}', 'url')">&times;</button>
                </li>
                {% endfor %}
            {% endif %}
            {% if knowledge.youtubes %}
                {% for item in knowledge.youtubes %}
                <li>
                    <span><i class="fab fa-youtube"></i> [YouTube] {{ item }}</span>
                    <button type="button" class="delete-file-btn" onclick="deleteKnowledge('{{ item | e }}', 'youtube')">&times;</button>
                </li>
                {% endfor %}
            {% endif %}
            {% if knowledge.files %}
                {% for item in knowledge.files %}
                <li>
                    <span><i class="fas fa-file-pdf"></i> [Archivo] {{ item }}</span>
                    <button type="button" class="delete-file-btn" onclick="deleteKnowledge('{{ item | e }}', 'file')">&times;</button>
                </li>
                {% endfor %}
            {% endif %}
        </ul>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const serverId = "{{ server.id }}";
    const saveBtn = document.getElementById('save-general-config');
    const sendPanelBtn = document.getElementById('send-panel-btn');
    const channelSelect = document.getElementById('send-panel-channel');
    
    // --- Cargar Canales de Discord ---
    async function loadChannels() {
        try {
            // (En un proyecto real, esto debería venir de una API del bot o del backend)
            // Simulación: asumimos que el usuario sabe el ID o lo tenemos en 'g'
            // Para una implementación real, necesitaríamos un endpoint /api/get_channels
            
            // Simulación simple con canales de texto
            const guildChannels = {{ server.channels | tojson | safe if server.channels else '[]' }};
            
            // Si no tenemos canales (desde select_server), pedirlos
            if (guildChannels.length === 0) {
                // Esto es más complejo, requiere una llamada a la API de Discord
                // Por ahora, lo dejamos así, asumiendo que el usuario pegará el ID
                // o que la info está en la sesión (lo cual no está)
                // console.warn('No se pudieron cargar canales del servidor.');
            }

            channelSelect.innerHTML = '<option value="">{{ _('ia_ticket_seleccionar_canal') }}</option>';
            guildChannels.filter(c => c.type === 0 || c.type === 5) // Tipo 0=Texto, 5=Anuncio
                .sort((a, b) => a.position - b.position)
                .forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `#${c.name}`;
                    channelSelect.appendChild(option);
                });

        } catch (error) {
            console.error('Error cargando canales:', error);
        }
    }
    // loadChannels(); // Descomentar si tenemos 'server.channels'
    
    // --- Guardar Configuración General (POST) ---
    saveBtn.addEventListener('click', async function() {
        showToast('warning', 'Guardando...'); // (Asumiendo que showToast existe)

        const embedConfig = {
            title: document.getElementById('embed-title').value,
            description: document.getElementById('embed-description').value,
            color: document.getElementById('embed-color').value,
            button_text: document.getElementById('embed-button-text').value,
        };

        const data = {
            ai_personality: document.getElementById('ai-personality').value,
            ticket_welcome_message: document.getElementById('ticket-welcome-message').value,
            ai_language: document.getElementById('ai-language').value,
            embed_config: embedConfig
        };

        try {
            const response = await fetch("{{ url_for('save_ia_ticket', server_id=serverId) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showToast('success', result.message);
            } else {
                showToast('error', result.error);
            }
        } catch (error) {
            showToast('error', 'Error de conexión al guardar.');
        }
    });

    // --- Enviar Panel (POST) ---
    sendPanelBtn.addEventListener('click', async function() {
        const channelId = channelSelect.value;
        if (!channelId) {
            showToast('error', '{{ _('ia_ticket_error_canal_invalido') }}');
            return;
        }
        
        showToast('warning', 'Enviando panel...');
        
        try {
            const response = await fetch("{{ url_for('send_ticket_panel', server_id=serverId) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: channelId })
            });
            const result = await response.json();
            if (result.success) {
                showToast('success', result.message);
            } else {
                showToast('error', result.error);
            }
        } catch (error) {
            showToast('error', 'Error de conexión al enviar panel.');
        }
    });

    // --- Knowledge Base: Tabs ---
    const tabButtons = document.querySelectorAll('.kb-tab-button');
    const tabPanes = document.querySelectorAll('.kb-tab-pane');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById('kb-tab-' + button.dataset.tab).classList.add('active');
        });
    });

    // --- Knowledge Base: Añadir Fuente (Texto, URL, YouTube) ---
    async function addKnowledge(type, content) {
        if (!content.trim()) {
            showToast('error', 'El contenido no puede estar vacío.');
            return;
        }
        
        showToast('warning', 'Añadiendo fuente...');
        
        try {
            const response = await fetch("{{ url_for('save_knowledge', server_id=serverId) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, content: content })
            });
            const result = await response.json();
            if (result.success) {
                showToast('success', result.message);
                // Recargar la página para ver la lista actualizada
                location.reload(); 
            } else {
                showToast('error', result.error);
            }
        } catch (error) {
            showToast('error', 'Error de conexión al añadir fuente.');
        }
    }
    
    document.getElementById('add-kb-text').addEventListener('click', () => {
        addKnowledge('text', document.getElementById('kb-input-text').value);
    });
    document.getElementById('add-kb-url').addEventListener('click', () => {
        addKnowledge('url', document.getElementById('kb-input-url').value);
    });
    document.getElementById('add-kb-youtube').addEventListener('click', () => {
        addKnowledge('youtube', document.getElementById('kb-input-youtube').value);
    });

    // --- Knowledge Base: Subir Archivo (File) ---
    const fileInput = document.getElementById('file-upload');
    fileInput.addEventListener('change', handleFileUpload);

    async function handleFileUpload() {
        const file = fileInput.files[0];
        if (!file) return;

        showToast('warning', 'Subiendo archivo: ' + file.name);
        
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch("{{ url_for('upload_knowledge', server_id=serverId) }}", {
                method: 'POST',
                body: formData
                // No 'Content-Type' header, el navegador lo pone (multipart/form-data)
            });
            
            const data = await response.json();

            // ### INICIO DEL FIX (Bug 1) ###
            if (data.success) {
                showToast('success', 'Archivo subido con éxito: ' + data.filename);
                
                // Actualizar la UI dinámicamente
                const fileList = document.getElementById('file-list');
                const newFileItem = document.createElement('li');
                
                // Crear el contenido del 'li'
                const icon = document.createElement('i');
                icon.className = 'fas fa-file-pdf'; // Asumir PDF por defecto, o cambiar
                
                const fileNameSpan = document.createElement('span');
                fileNameSpan.textContent = ` [Archivo] ${data.filename}`;
                fileNameSpan.prepend(icon); // Poner icono al inicio
                
                const deleteButton = document.createElement('button');
                deleteButton.type = 'button';
                deleteButton.className = 'delete-file-btn';
                deleteButton.innerHTML = '&times;'; // '×'
                deleteButton.onclick = function() {
                    // 'data.filename' es el nombre del archivo que se usa como ID
                    deleteKnowledge(data.filename, 'file');
                };
                
                // Ensamblar y añadir a la lista
                newFileItem.appendChild(fileNameSpan);
                newFileItem.appendChild(deleteButton);
                fileList.appendChild(newFileItem);
                
                // Limpiar el input de archivo
                fileInput.value = ''; 

            } else {
                showToast('error', data.error || 'Error al subir el archivo');
            }
            // ### FIN DEL FIX ###

        } catch (error) {
            console.error('Error subiendo archivo:', error);
            showToast('error', 'Error de conexión al subir archivo.');
        }
    }

});

// --- Knowledge Base: Eliminar Fuente ---
// (Se deja fuera del DOMContentLoaded para que sea global y accesible por 'onclick')
async function deleteKnowledge(content, type) {
    if (!confirm(`¿Estás seguro de que quieres eliminar esta fuente?\n\n(${type}: ${content.substring(0, 50)}...)`)) {
        return;
    }
    
    showToast('warning', 'Eliminando fuente...');
    
    try {
        const response = await fetch("{{ url_for('delete_knowledge', server_id=server.id) }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type, content: content })
        });
        const result = await response.json();
        if (result.success) {
            showToast('success', result.message);
            // Recargar la página para ver la lista actualizada
            location.reload();
        } else {
            showToast('error', result.error);
        }
    } catch (error) {
        showToast('error', 'Error de conexión al eliminar fuente.');
    }
}

// --- Color Picker ---
document.getElementById('embed-color-picker').addEventListener('input', function() {
    document.getElementById('embed-color').value = this.value;
    // Disparar evento 'input' en el campo de texto para que el preview.js lo detecte
    document.getElementById('embed-color').dispatchEvent(new Event('input'));
});
document.getElementById('embed-color').addEventListener('input', function() {
    document.getElementById('embed-color-picker').value = this.value;
});

</script>
{% endblock %}
