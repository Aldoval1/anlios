{% extends "layout.html" %}

{% block title %}{{ title }} - {{ server.name }}{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Hoja de estilos específica para el módulo Designer -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/designer.css') }}">
{% endblock %}

{% block content %}
<div class="main-content-header">
    <a href="{{ url_for('manage_server', server_id=server.id) }}" class="back-button">&larr; {{ _('volver_a_modulos') }}</a>
    <h1>
        <img src="https://cdn.discordapp.com/icons/{{ server.id }}/{{ server.icon }}.png?size=64" alt="{{ _('icono_servidor') }}" class="server-icon-title">
        {{ server.name }}
    </h1>
</div>

<div class="module-container module-designer">
    
    <div class="module-header">
        <i class="fas fa-drafting-compass icon-designer"></i>
        <div class="module-header-info">
            <!-- TEXTO TRADUCIDO -->
            <h2>{{ _('designer_titulo') }}</h2>
            <p>{{ _('designer_descripcion') }}</p>
        </div>
    </div>

    <!-- Interfaz de Chat del Designer -->
    <div class="designer-chat-container card">
        <div class="designer-chat-box" id="designer-chat-box">
            
            <!-- Mensaje de bienvenida -->
            <div class="chat-message bot-message">
                <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Anlios" class="chat-avatar">
                <div class="chat-message-content">
                    <p>{{ _('designer_bienvenida') }}</p>
                    <strong>{{ _('designer_ejemplos') }}</strong>
                    <ul>
                        <li>{{ _('designer_ejemplo_1') }}</li>
                        <li>{{ _('designer_ejemplo_2') }}</li>
                        <li>{{ _('designer_ejemplo_3') }}</li>
                    </ul>
                </div>
            </div>
            
            <!-- Historial de chat (cargado por Jinja) -->
            {% for msg in chat_history %}
                {% if msg.role == 'user' %}
                <div class="chat-message user-message">
                    <img src="https://cdn.discordapp.com/avatars/{{ user_info.id }}/{{ user_info.avatar }}.png?size=64" alt="{{ _('tu_avatar') }}" class="chat-avatar">
                    <div class="chat-message-content">
                        <p>{{ msg.content }}</p>
                    </div>
                </div>
                {% elif msg.role == 'model' %}
                <div class="chat-message bot-message">
                    <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Anlios" class="chat-avatar">
                    <div class="chat-message-content">
                        <p>{{ msg.content | safe }}</p>
                        {% if msg.actions and msg.actions | length > 0 %}
                            <div class="actions-summary">
                                <strong>{{ _('designer_plan_titulo') }} ({{ msg.actions | length }} {{ _('designer_plan_acciones') }}):</strong>
                                <ul>
                                    {% for action in msg.actions %}
                                        <li><code>{{ action.action_type }}</code>: {{ action.name }}</li>
                                    {% endfor %}
                                </ul>
                                <p><i>{{ _('designer_plan_ejecutando') }}</i></p>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}

            <!-- Plantilla de mensaje de 'hablando' (oculto) -->
            <div class="chat-message bot-message" id="bot-thinking-template" style="display: none;">
                <img src="{{ url_for('static', filename='images/favicon.png') }}" alt="Anlios" class="chat-avatar">
                <div class="chat-message-content">
                    <img src="{{ url_for('static', filename='images/hablando.gif') }}" alt="{{ _('designer_chat_hablando_alt') }}" class="loading-gif">
                </div>
            </div>

        </div>
        
        <!-- Barra de input -->
        <div class="designer-chat-input-bar">
            <input type="text" id="designer-prompt-input" placeholder="{{ _('designer_chat_placeholder') }}">
            <button id="designer-send-btn" class="button-primary">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatBox = document.getElementById('designer-chat-box');
    const promptInput = document.getElementById('designer-prompt-input');
    const sendBtn = document.getElementById('designer-send-btn');
    const thinkingTemplate = document.getElementById('bot-thinking-template');

    // Función para auto-scroll al final
    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    scrollToBottom(); // Al cargar la página

    // Función para agregar un mensaje al chat
    function addMessage(role, content, actions = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', role === 'user' ? 'user-message' : 'bot-message');

        const avatarImg = document.createElement('img');
        avatarImg.classList.add('chat-avatar');
        if (role === 'user') {
            avatarImg.src = "https://cdn.discordapp.com/avatars/{{ user_info.id }}/{{ user_info.avatar }}.png?size=64";
            avatarImg.alt = "{{ _('tu_avatar') }}";
        } else {
            avatarImg.src = "{{ url_for('static', filename='images/favicon.png') }}";
            avatarImg.alt = "Anlios";
        }

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('chat-message-content');
        
        const p = document.createElement('p');
        p.textContent = content; // Usar textContent para evitar inyección de HTML
        contentDiv.appendChild(p);
        
        // Si es un bot y tiene acciones, mostrarlas
        if (role === 'model' && actions && actions.length > 0) {
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('actions-summary');
            
            const strong = document.createElement('strong');
            strong.textContent = `{{ _('designer_plan_titulo') }} (${actions.length} {{ _('designer_plan_acciones') }}):`;
            actionsDiv.appendChild(strong);
            
            const ul = document.createElement('ul');
            actions.forEach(action => {
                const li = document.createElement('li');
                li.innerHTML = `<code>${action.action_type}</code>: ${action.name}`;
                ul.appendChild(li);
            });
            actionsDiv.appendChild(ul);
            
            const p_exec = document.createElement('p');
            p_exec.innerHTML = `<i>{{ _('designer_plan_ejecutando') }}</i>`;
            actionsDiv.appendChild(p_exec);
            
            contentDiv.appendChild(actionsDiv);
        }

        messageDiv.appendChild(avatarImg);
        messageDiv.appendChild(contentDiv);
        chatBox.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
    }

    // Función para manejar el envío
    async function handleSendPrompt() {
        const prompt = promptInput.value.trim();
        if (prompt === '') return;

        // 1. Deshabilitar input y mostrar mensaje de usuario
        promptInput.value = '';
        promptInput.disabled = true;
        sendBtn.disabled = true;
        addMessage('user', prompt);

        // 2. Mostrar "hablando..."
        const thinkingMessage = thinkingTemplate.cloneNode(true);
        thinkingMessage.style.display = 'flex';
        chatBox.appendChild(thinkingMessage);
        scrollToBottom();

        // 3. Enviar al backend
        try {
            const response = await fetch("{{ url_for('designer_chat', server_id=server.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ prompt: prompt })
            });

            // 4. Quitar "hablando..."
            chatBox.removeChild(thinkingMessage);

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
            }

            // 5. Mostrar respuesta del bot
            const data = await response.json();
            if (data.error) {
                // Error de lógica (ej. IA falló)
                addMessage('model', `{{ _('error_prefix') }} ${data.error}`);
            } else {
                // Éxito
                addMessage('model', data.content, data.actions);
            }

        } catch (error) {
            // Error de red o parseo
            console.error('Error en designer_chat:', error);
            chatBox.removeChild(thinkingMessage); // Asegurarse de quitarlo en caso de error
            addMessage('model', `{{ _('error_prefix') }} ${error.message}`);
        }

        // 6. Rehabilitar input
        promptInput.disabled = false;
        sendBtn.disabled = false;
        promptInput.focus();
    }

    // Event Listeners
    sendBtn.addEventListener('click', handleSendPrompt);
    promptInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleSendPrompt();
        }
    });

});
</script>
{% endblock %}
