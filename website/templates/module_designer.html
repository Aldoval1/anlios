{% extends "dashboard.html" %}

{% block theme_styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/designer.css') }}">
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid h-100 designer-container">
    <div class="row h-100">
        <!-- Panel Izquierdo: Simulaci√≥n del Servidor -->
        <div class="col-lg-5 h-100 d-flex flex-column">
            <div class="card flex-grow-1">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>{{ _('Server Simulation') }}</h4>
                    <div id="loading-spinner" class="spinner-border spinner-border-sm" role="status" style="display: none;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="card-body" id="server-simulation-container">
                    <p class="text-muted">{{ _('Loading server structure...') }}</p>
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Chat con IA y Controles -->
        <div class="col-lg-7 h-100 d-flex flex-column">
            <div class="card flex-grow-1">
                <div class="card-header">
                    <h4>{{ _('AI Assistant') }}</h4>
                </div>
                <div class="card-body d-flex flex-column" id="ai-chat-container">
                    <!-- √Årea de Mensajes del Chat -->
                    <div id="chat-messages" class="flex-grow-1 mb-3">
                        <div class="ai-message">
                            <p>{{ _('Hello! I am your server design assistant. Tell me what changes you would like to make. For example: "Create a category for staff with a private text channel and a voice channel."') }}</p>
                        </div>
                    </div>
                    <!-- Input del Usuario -->
                    <div class="input-group">
                        <input type="text" id="user-prompt-input" class="form-control" placeholder="{{ _('Type your request here...') }}">
                        <button class="btn btn-primary" id="send-prompt-btn">{{ _('Send') }}</button>
                    </div>
                </div>
                <div class="card-footer text-center">
                    <button class="btn btn-success w-100 mb-2" id="save-changes-btn">{{ _('Save and Apply Changes') }}</button>
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-secondary" id="undo-btn" title="{{ _('Undo') }}" disabled>‚Üê</button>
                        <button type="button" class="btn btn-danger" id="cancel-btn" title="{{ _('Cancel All') }}" disabled>X</button>
                        <button type="button" class="btn btn-secondary" id="redo-btn" title="{{ _('Redo') }}" disabled>‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const guildId = '{{ active_guild_id }}';

    // Translations passed from Flask
    const translations = {
        roles: "{{ _('Roles') }}",
        channels: "{{ _('Channels') }}",
        errorInvalidStructure: "{{ _('Error: Invalid server structure received.') }}",
        changesReverted: "{{ _('All changes have been reverted to the initial state.') }}",
        failedToLoad: "{{ _('Failed to load server structure.') }}",
        aiFailed: "{{ _('The AI assistant failed to process the request.') }}",
        structureUpdated: "{{ _('Done! Here is the updated structure. You can continue making changes or save them.') }}",
        errorPrefix: "{{ _('Error:') }}",
        unknownError: "{{ _('An unknown error occurred.') }}",
        errorApplying: "{{ _('Error applying changes:') }}"
    };

    // UI Elements
    const simulationContainer = document.getElementById('server-simulation-container');
    const chatMessages = document.getElementById('chat-messages');
    const promptInput = document.getElementById('user-prompt-input');
    const sendBtn = document.getElementById('send-prompt-btn');
    const saveBtn = document.getElementById('save-changes-btn');
    const undoBtn = document.getElementById('undo-btn');
    const redoBtn = document.getElementById('redo-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const spinner = document.getElementById('loading-spinner');

    // State Management
    let initialStructure = {};
    let currentStructure = {};
    let history = [];
    let historyIndex = -1;

    // --- RENDER FUNCTIONS ---
    function renderServer(structure) {
        // CORRECCI√ìN: Verificar que la estructura y sus componentes existan antes de renderizar
        if (!structure || !structure.roles || !structure.categories || !structure.channels_no_category) {
            simulationContainer.innerHTML = `<p class="text-danger">${translations.errorInvalidStructure}</p>`;
            return;
        }

        simulationContainer.innerHTML = ''; // Clear previous state

        const serverHeader = document.createElement('div');
        serverHeader.className = 'sim-server-header';
        serverHeader.innerHTML = `
            <img src="${structure.icon_url}" alt="Server Icon" class="sim-server-icon">
            <h5>${structure.name}</h5>
        `;
        simulationContainer.appendChild(serverHeader);

        const rolesHeader = document.createElement('h6');
        rolesHeader.textContent = translations.roles;
        rolesHeader.className = 'mt-3';
        simulationContainer.appendChild(rolesHeader);
        const rolesContainer = document.createElement('div');
        rolesContainer.className = 'sim-roles-container';
        structure.roles.forEach(role => {
            const rolePill = document.createElement('div');
            rolePill.className = 'sim-role-pill';
            rolePill.style.borderColor = role.color;
            rolePill.innerHTML = `<span class="sim-role-dot" style="background-color: ${role.color};"></span> ${role.name}`;
            rolesContainer.appendChild(rolePill);
        });
        simulationContainer.appendChild(rolesContainer);

        const channelsHeader = document.createElement('h6');
        channelsHeader.textContent = translations.channels;
        channelsHeader.className = 'mt-3';
        simulationContainer.appendChild(channelsHeader);

        structure.categories.forEach(category => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'sim-category';
            categoryDiv.innerHTML = `<span>${category.name.toUpperCase()}</span>`;
            simulationContainer.appendChild(categoryDiv);

            // CORRECCI√ìN: Asegurarse de que category.channels sea un array
            if (Array.isArray(category.channels)) {
                category.channels.forEach(channel => {
                    const channelDiv = document.createElement('div');
                    channelDiv.className = 'sim-channel';
                    const icon = channel.type === 'text' ? '#' : 'üîä';
                    channelDiv.innerHTML = `<span class="sim-channel-icon">${icon}</span> ${channel.name}`;
                    simulationContainer.appendChild(channelDiv);
                });
            }
        });

        structure.channels_no_category.forEach(channel => {
            const channelDiv = document.createElement('div');
            channelDiv.className = 'sim-channel';
            const icon = channel.type === 'text' ? '#' : 'üîä';
            channelDiv.innerHTML = `<span class="sim-channel-icon">${icon}</span> ${channel.name}`;
            simulationContainer.appendChild(channelDiv);
        });
    }

    function addChatMessage(message, sender = 'ai') {
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'ai' ? 'ai-message' : 'user-message';
        messageDiv.innerHTML = `<p>${message}</p>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- STATE & HISTORY MANAGEMENT ---
    function updateHistory(newStructure) {
        if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
        }
        history.push(JSON.parse(JSON.stringify(newStructure)));
        historyIndex++;
        updateControlButtons();
    }

    function updateControlButtons() {
        undoBtn.disabled = historyIndex <= 0;
        redoBtn.disabled = historyIndex >= history.length - 1;
        cancelBtn.disabled = historyIndex <= 0;
    }
    
    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            currentStructure = JSON.parse(JSON.stringify(history[historyIndex]));
            renderServer(currentStructure);
            updateControlButtons();
        }
    }
    
    function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            currentStructure = JSON.parse(JSON.stringify(history[historyIndex]));
            renderServer(currentStructure);
            updateControlButtons();
        }
    }

    function cancelAll() {
        currentStructure = JSON.parse(JSON.stringify(initialStructure));
        history = [JSON.parse(JSON.stringify(initialStructure))];
        historyIndex = 0;
        renderServer(currentStructure);
        updateControlButtons();
        addChatMessage(translations.changesReverted, 'ai');
    }

    // --- API CALLS ---
    async function fetchServerStructure() {
        spinner.style.display = 'inline-block';
        try {
            const response = await fetch(`/api/designer/${guildId}/structure`);
            if (!response.ok) throw new Error(translations.failedToLoad);
            const data = await response.json();
            initialStructure = JSON.parse(JSON.stringify(data));
            currentStructure = JSON.parse(JSON.stringify(data));
            history = [JSON.parse(JSON.stringify(data))];
            historyIndex = 0;
            renderServer(currentStructure);
            updateControlButtons();
        } catch (error) {
            simulationContainer.innerHTML = `<p class="text-danger">${error.message}</p>`;
        } finally {
            spinner.style.display = 'none';
        }
    }

    async function processPrompt() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        addChatMessage(prompt, 'user');
        promptInput.value = '';
        spinner.style.display = 'inline-block';
        sendBtn.disabled = true;

        try {
            const response = await fetch(`/api/designer/${guildId}/process_prompt`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt, structure: currentStructure })
            });

            const newStructure = await response.json();
            if (!response.ok) throw new Error(newStructure.error || translations.aiFailed);


            currentStructure = newStructure;
            updateHistory(currentStructure);
            renderServer(currentStructure);
            addChatMessage(translations.structureUpdated, 'ai');

        } catch (error) {
            addChatMessage(`${translations.errorPrefix} ${error.message}`, 'ai');
        } finally {
            spinner.style.display = 'none';
            sendBtn.disabled = false;
        }
    }

    async function applyChanges() {
        spinner.style.display = 'inline-block';
        saveBtn.disabled = true;

        try {
            const response = await fetch(`/api/designer/${guildId}/apply_changes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initial_structure: initialStructure, final_structure: currentStructure })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.error || translations.unknownError);

            addChatMessage(result.message, 'ai');
            fetchServerStructure();
        } catch (error) {
            addChatMessage(`${translations.errorApplying} ${error.message}`, 'ai');
        } finally {
            spinner.style.display = 'none';
            saveBtn.disabled = false;
        }
    }

    // --- EVENT LISTENERS ---
    sendBtn.addEventListener('click', processPrompt);
    promptInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') processPrompt();
    });
    saveBtn.addEventListener('click', applyChanges);
    undoBtn.addEventListener('click', undo);
    redoBtn.addEventListener('click', redo);
    cancelBtn.addEventListener('click', cancelAll);

    // --- INITIAL LOAD ---
    fetchServerStructure();
});
</script>
{% endblock %}
